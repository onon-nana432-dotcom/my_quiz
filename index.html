<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>大洲市 アンケート</title>
    <style>
        :root { --blue: #007bff; --green: #28a745; --gray: #6c757d; --bg: #f4f7f9; }
        body { font-family: "Helvetica Neue", Arial, sans-serif; background: var(--bg); margin: 0; padding: 0; display: flex; justify-content: center; }
        .container { background: white; width: 100%; max-width: 700px; min-height: 100vh; padding: 40px 20px; box-sizing: border-box; position: relative; padding-bottom: 100px; }
        .screen { display: none; }
        .active { display: block; animation: fadeIn 0.2s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        #id-display { position: absolute; top: 10px; left: 15px; font-size: 0.8rem; color: #999; font-weight: bold; }
        h2 { font-size: 1.3rem; color: #333; margin-bottom: 20px; border-left: 5px solid var(--blue); padding-left: 15px; line-height: 1.4; }
        .desc { background: #eef2f7; padding: 15px; border-radius: 10px; font-size: 0.95rem; margin-bottom: 20px; color: #444; }
        
        .options { display: flex; flex-direction: column; gap: 10px; margin: 20px 0; }
        .opt { display: flex; align-items: center; padding: 15px; border: 2px solid #eee; border-radius: 10px; cursor: pointer; font-size: 1.05rem; transition: 0.2s; }
        .opt:active { background: #f0f0f0; }
        .opt input { margin-right: 15px; transform: scale(1.4); }
        
        textarea { width: 100%; height: 120px; padding: 15px; border-radius: 10px; border: 2px solid #ddd; font-size: 1rem; box-sizing: border-box; }
        
        /* 地図エリアと赤い点 */
        .map-box { width: 100%; height: 400px; background: #ddd; border-radius: 15px; position: relative; overflow: hidden; border: 2px solid #ccc; background-image: url('map.png'); background-size: cover; background-position: center; }
        .dot { position: absolute; width: 18px; height: 18px; background: red; border-radius: 50%; border: 3px solid white; transform: translate(-50%, -50%); pointer-events: none; z-index: 10; display: block !important; box-shadow: 0 0 5px rgba(0,0,0,0.5); }

        .nav { display: flex; justify-content: space-between; margin-top: 30px; gap: 15px; }
        button { flex: 1; padding: 18px; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: bold; cursor: pointer; }
        .btn-next { background: var(--blue); color: white; }
        .btn-back { background: var(--gray); color: white; }
        .btn-start { background: var(--green); color: white; width: 100%; font-size: 1.3rem; }
        
        /* 管理用エリア（最初に戻る・CSV） */
        .btn-reset-small { position: fixed; bottom: 10px; right: 10px; padding: 5px 10px; font-size: 0.7rem; background: rgba(0,0,0,0.2); color: white; border-radius: 4px; width: auto; flex: none; font-weight: normal; }
        .admin-section { margin-top: 200px; border-top: 1px dashed #ccc; padding-top: 20px; text-align: center; }
        .btn-admin { background: #333; color: white; font-size: 0.8rem; padding: 10px; margin: 5px; width: auto; display: inline-block; }
    </style>
</head>
<body>

<div class="container">
    <div id="id-display">回答者ID: <span id="current-id">1</span></div>
    
    <button class="btn-reset-small" onclick="if(confirm('最初に戻りますか？現在の回答は保存されません。')) location.reload()">最初に戻る</button>

    <div id="q0" class="screen active">
        <h1 style="text-align:center; margin-top:100px;">市民文化会館における<br>水害伝承スペース提案<br>アンケート</h1>
        <p style="text-align:center; color:#666;">ご協力をお願いいたします。</p>
        <button class="btn-start" onclick="move(1)" style="margin-top:50px;">アンケートを始める</button>

        <div class="admin-section">
            <p style="font-size:0.7rem; color:#bbb;">管理者メニュー</p>
            <button class="btn-admin" onclick="downloadCSV()">CSVをダウンロード</button>
            <button class="btn-admin" style="background:#cc0000;" onclick="if(confirm('全てのデータを消去しますか？')) { localStorage.removeItem('survey_data'); localStorage.setItem('respondentId', 1); location.reload(); }">データ全消去</button>
        </div>
    </div>

    <div id="q1" class="screen">
        <h2>Q1. 年齢</h2>
        <div class="options">
            <label class="opt"><input type="radio" name="Q1" value="10代以下"> 10代以下</label>
            <label class="opt"><input type="radio" name="Q1" value="20代"> 20代</label>
            <label class="opt"><input type="radio" name="Q1" value="30代"> 30代</label>
            <label class="opt"><input type="radio" name="Q1" value="40代"> 40代</label>
            <label class="opt"><input type="radio" name="Q1" value="50代"> 50代</label>
            <label class="opt"><input type="radio" name="Q1" value="60代"> 60代</label>
            <label class="opt"><input type="radio" name="Q1" value="70代以上"> 70代以上</label>
        </div>
        <div class="nav"><button class="btn-back" onclick="move(0)">戻る</button><button class="btn-next" onclick="move(2)">次へ</button></div>
    </div>

    <div id="q2" class="screen">
        <h2>Q2. 職業（複数選択可）</h2>
        <div class="options">
            <label class="opt"><input type="checkbox" name="Q2" value="会社員・公務員"> 会社員・公務員</label>
            <label class="opt"><input type="checkbox" name="Q2" value="自営業・フリーランス"> 自営業・フリーランス</label>
            <label class="opt"><input type="checkbox" name="Q2" value="学生"> 学生</label>
            <label class="opt"><input type="checkbox" name="Q2" value="専業主婦・主夫"> 専業主婦・主夫</label>
            <label class="opt"><input type="checkbox" name="Q2" value="その他"> その他</label>
        </div>
        <div class="nav"><button class="btn-back" onclick="move(1)">戻る</button><button class="btn-next" onclick="move(3)">次へ</button></div>
    </div>

    <div id="q3" class="screen">
        <h2>Q3. 居住地</h2>
        <div class="options" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <label class="opt"><input type="radio" name="Q3" value="大洲"> 大洲</label>
            <label class="opt"><input type="radio" name="Q3" value="中村"> 中村</label>
            <label class="opt"><input type="radio" name="Q3" value="西大洲"> 西大洲</label>
            <label class="opt"><input type="radio" name="Q3" value="若宮"> 若宮</label>
            <label class="opt"><input type="radio" name="Q3" value="久米"> 久米</label>
            <label class="opt"><input type="radio" name="Q3" value="南久米"> 南久米</label>
            <label class="opt"><input type="radio" name="Q3" value="肱南町"> 肱南町</label>
            <label class="opt"><input type="radio" name="Q3" value="平野町"> 平野町</label>
            <label class="opt"><input type="radio" name="Q3" value="東大洲"> 東大洲</label>
            <label class="opt"><input type="radio" name="Q3" value="徳森"> 徳森</label>
            <label class="opt"><input type="radio" name="Q3" value="新谷"> 新谷</label>
            <label class="opt"><input type="radio" name="Q3" value="菅田町"> 菅田町</label>
            <label class="opt"><input type="radio" name="Q3" value="柳沢"> 柳沢</label>
            <label class="opt"><input type="radio" name="Q3" value="三善"> 三善</label>
            <label class="opt"><input type="radio" name="Q3" value="その他"> その他</label>
        </div>
        <div class="nav"><button class="btn-back" onclick="move(2)">戻る</button><button class="btn-next" onclick="move(4)">次へ</button></div>
    </div>

    <div id="q4" class="screen">
        <h2>Q4. 水害の被災経験の有無</h2>
        <div class="options">
            <label class="opt"><input type="radio" name="Q4" value="ある大"> ある(大きな被害)</label>
            <label class="opt"><input type="radio" name="Q4" value="ある小"> ある(少しの被害)</label>
            <label class="opt"><input type="radio" name="Q4" value="ない"> ない</label>
        </div>
        <div class="nav"><button class="btn-back" onclick="move(3)">戻る</button><button class="btn-next" onclick="move(5)">次へ</button></div>
    </div>

    <div id="q5" class="screen">
        <h2>Q5. 同居者の人数</h2>
        <div class="options">
            <label class="opt"><input type="radio" name="Q5" value="1人"> 1人</label>
            <label class="opt"><input type="radio" name="Q5" value="2人"> 2人</label>
            <label class="opt"><input type="radio" name="Q5" value="3人"> 3人</label>
            <label class="opt"><input type="radio" name="Q5" value="4人以上"> 4人以上</label>
        </div>
        <div class="nav"><button class="btn-back" onclick="move(4)">戻る</button><button class="btn-next" onclick="move(6)">次へ</button></div>
    </div>

    <div id="q6" class="screen">
        <div class="desc">市民文化会館に水害伝承のスペースを提案したいと考えています。</div>
        <h2>Q6. 伝承館に行きたいと思いますか？</h2>
        <div class="options">
            <label class="opt"><input type="radio" name="Q6" value="はい"> はい</label>
            <label class="opt"><input type="radio" name="Q6" value="いいえ"> いいえ</label>
        </div>
        <div class="nav"><button class="btn-back" onclick="move(5)">戻る</button><button class="btn-next" onclick="move(7)">次へ</button></div>
    </div>

    <div id="q7" class="screen">
        <h2>Q7. 行きたいと思う展示内容は？（複数選択可）</h2>
        <div class="options">
            <label class="opt"><input type="checkbox" name="Q7" value="写真"> 写真・映像</label>
            <label class="opt"><input type="checkbox" name="Q7" value="体験談"> 体験談</label>
            <label class="opt"><input type="checkbox" name="Q7" value="ワークショップ"> ワークショップ</label>
            <label class="opt"><input type="checkbox" name="Q7" value="子ども向け"> 子ども向け体験</label>
            <label class="opt"><input type="checkbox" name="Q7" value="ARVR"> AR・VR</label>
            <label class="opt"><input type="checkbox" name="Q7" value="屋内遊具"> 屋内スペース</label>
            <label class="opt"><input type="checkbox" name="Q7" value="自習"> 勉強・読書</label>
            <label class="opt"><input type="checkbox" name="Q7" value="図書室"> 図書室</label>
            <label class="opt"><input type="checkbox" name="Q7" value="カフェ"> カフェ・休憩</label>
            <label class="opt"><input type="checkbox" name="Q7" value="その他"> その他</label>
        </div>
        <div class="nav"><button class="btn-back" onclick="move(6)">戻る</button><button class="btn-next" onclick="move(8)">次へ</button></div>
    </div>

    <div id="q8" class="screen">
        <h2>Q8. 伝承館を設置したい場所</h2>
        <p>地図上の希望の場所をタップしてください。</p>
        <div class="map-box" onclick="setMap(event)">
            <div id="map-dot"></div>
        </div>
        <div class="nav"><button class="btn-back" onclick="move(7)">戻る</button><button class="btn-next" onclick="move(9)">次へ</button></div>
    </div>

    <div id="q9" class="screen">
        <h2>Q9. 現在の居住地を選んだ理由は？（複数選択可）</h2>
        <div class="options">
            <label class="opt"><input type="checkbox" name="Q9" value="昔から"> 昔から</label>
            <label class="opt"><input type="checkbox" name="Q9" value="親族近"> 親族近</label>
            <label class="opt"><input type="checkbox" name="Q9" value="地価安"> 地価安</label>
            <label class="opt"><input type="checkbox" name="Q9" value="利便性"> 利便性</label>
            <label class="opt"><input type="checkbox" name="Q9" value="子育て"> 子育て</label>
            <label class="opt"><input type="checkbox" name="Q9" value="災害リスク低"> リスク低</label>
            <label class="opt"><input type="checkbox" name="Q9" value="その他"> その他</label>
        </div>
        <div class="nav"><button class="btn-back" onclick="move(8)">戻る</button><button class="btn-next" onclick="move(10)">次へ</button></div>
    </div>

    <div id="q10" class="screen">
        <h2>Q10. 伊予大洲駅周辺に住みたい条件（複数選択可）</h2>
        <div class="options">
            <label class="opt"><input type="checkbox" name="Q10" value="地価安"> 地価安</label>
            <label class="opt"><input type="checkbox" name="Q10" value="店近"> 店近</label>
            <label class="opt"><input type="checkbox" name="Q10" value="利便性"> 利便性</label>
            <label class="opt"><input type="checkbox" name="Q10" value="公共交通"> 公共交通</label>
            <label class="opt"><input type="checkbox" name="Q10" value="駐車場"> 駐車場</label>
            <label class="opt"><input type="checkbox" name="Q10" value="ピロティ"> ピロティ</label>
            <label class="opt"><input type="checkbox" name="Q10" value="病院近"> 病院近</label>
            <label class="opt"><input type="checkbox" name="Q10" value="その他"> その他</label>
        </div>
        <div class="nav"><button class="btn-back" onclick="move(9)">戻る</button><button class="btn-next" onclick="move(11)">次へ</button></div>
    </div>

    <div id="q11" class="screen">
        <h2>Q11. 免許返納についてのご意見</h2>
        <div class="options">
            <label class="opt"><input type="radio" name="Q11" value="返納済"> 返納済</label>
            <label class="opt"><input type="radio" name="Q11" value="予定"> 予定</label>
            <label class="opt"><input type="radio" name="Q11" value="条件次第"> 条件次第</label>
            <label class="opt"><input type="radio" name="Q11" value="しない"> しない</label>
        </div>
        <textarea id="Q11_text" placeholder="自由記述"></textarea>
        <div class="nav"><button class="btn-back" onclick="move(10)">戻る</button><button class="btn-next" onclick="move(12)">次へ</button></div>
    </div>

    <div id="q12" class="screen">
        <h2>Q12. 避難指示時の避難手段</h2>
        <div class="options">
            <label class="opt"><input type="radio" name="Q12" value="車"> 車</label>
            <label class="opt"><input type="radio" name="Q12" value="徒歩"> 徒歩</label>
            <label class="opt"><input type="radio" name="Q12" value="二輪"> 二輪</label>
            <label class="opt"><input type="radio" name="Q12" value="避難不要"> 不要</label>
            <label class="opt"><input type="radio" name="Q12" value="その他"> その他</label>
        </div>
        <div class="nav"><button class="btn-back" onclick="move(11)">戻る</button><button class="btn-next" onclick="move(13)">次へ</button></div>
    </div>

    <div id="q13" class="screen">
        <h2>Q13. 車を避難させるならどこですか？</h2>
        <textarea id="Q13" placeholder="具体的な場所など"></textarea>
        <div class="nav"><button class="btn-back" onclick="move(12)">戻る</button><button class="btn-next" onclick="move(14)">次へ</button></div>
    </div>

    <div id="q14" class="screen">
        <h2>Q14. 避難時に欲しい支援は？（複数選択可）</h2>
        <div class="options">
            <label class="opt"><input type="checkbox" name="Q14" value="バス"> バス</label>
            <label class="opt"><input type="checkbox" name="Q14" value="情報"> 情報</label>
            <label class="opt"><input type="checkbox" name="Q14" value="駐車場"> 駐車場</label>
            <label class="opt"><input type="checkbox" name="Q14" value="物資"> 物資</label>
            <label class="opt"><input type="checkbox" name="Q14" value="その他"> その他</label>
        </div>
        <div class="nav"><button class="btn-back" onclick="move(13)">戻る</button><button class="btn-next" onclick="move(15)">次へ</button></div>
    </div>

    <div id="q15" class="screen">
        <h2>Q15. 避難時に欲しい情報は？（複数選択可）</h2>
        <div class="options">
            <label class="opt"><input type="checkbox" name="Q15" value="避難所状況"> 避難所状況</label>
            <label class="opt"><input type="checkbox" name="Q15" value="設備"> 設備</label>
            <label class="opt"><input type="checkbox" name="Q15" value="浸水予測"> 浸水予測</label>
            <label class="opt"><input type="checkbox" name="Q15" value="通行止め"> 通行止め</label>
            <label class="opt"><input type="checkbox" name="Q15" value="タイミング"> タイミング</label>
        </div>
        <div class="nav"><button class="btn-back" onclick="move(14)">戻る</button><button class="btn-next" onclick="move(16)">次へ</button></div>
    </div>

    <div id="q16" class="screen">
        <h2>Q16. 普段のバス利用頻度は？</h2>
        <div class="options">
            <label class="opt"><input type="radio" name="Q16" value="よく使う"> よく使う</label>
            <label class="opt"><input type="radio" name="Q16" value="たまに使う"> たまに使う</label>
            <label class="opt"><input type="radio" name="Q16" value="ほとんど使わない"> ほとんど使わない</label>
        </div>
        <div class="nav"><button class="btn-back" onclick="move(15)">戻る</button><button class="btn-next" onclick="checkBusBranch()">次へ</button></div>
    </div>

    <div id="q162" class="screen">
        <h2>Q16-2. バスの利用目的は？（複数選択可）</h2>
        <div class="options">
            <label class="opt"><input type="checkbox" name="Q162" value="通学通勤"> 通学・通勤</label>
            <label class="opt"><input type="checkbox" name="Q162" value="通院"> 通院</label>
            <label class="opt"><input type="checkbox" name="Q162" value="買い物"> 買い物</label>
            <label class="opt"><input type="checkbox" name="Q162" value="遊び"> 遊び</label>
            <label class="opt"><input type="checkbox" name="Q162" value="その他"> その他</label>
        </div>
        <div class="nav"><button class="btn-back" onclick="move(16)">戻る</button><button class="btn-next" onclick="move(17)">次へ</button></div>
    </div>

    <div id="q17" class="screen">
        <h2>Q17. 災害時のバス利用意向</h2>
        <div class="options">
            <label class="opt"><input type="radio" name="Q17" value="すぐ乗る"> すぐ乗る</label>
            <label class="opt"><input type="radio" name="Q17" value="自力避難"> 自力避難</label>
            <label class="opt"><input type="radio" name="Q17" value="様子見"> 様子見</label>
        </div>
        <div class="nav"><button class="btn-back" onclick="move(16)">戻る</button><button class="btn-next" onclick="finish()">回答を完了する</button></div>
    </div>

    <div id="qEnd" class="screen" style="text-align:center;">
        <h2>ご協力ありがとうございました</h2>
        <p>回答データは保存されました。</p>
        <button class="btn-start" onclick="location.reload()" style="background:var(--blue); margin-top:30px;">次の人へ</button>
    </div>
</div>

<script>
    let respondentId = localStorage.getItem('respondentId') || 1;
    document.getElementById('current-id').innerText = respondentId;
    let mapData = "未選択";

    function move(n) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('q' + n).classList.add('active');
        window.scrollTo(0, 0);
    }

    // Q16の答えによって16-2に行くか17に行くか分岐
    function checkBusBranch() {
        const busFreq = document.querySelector('input[name="Q16"]:checked')?.value;
        if (busFreq === "ほとんど使わない") {
            move(17);
        } else if (busFreq) {
            move(162);
        } else {
            alert("項目を選択してください");
        }
    }

    // 地図タップ処理
    function setMap(e) {
        const dot = document.getElementById('map-dot');
        const rect = e.currentTarget.getBoundingClientRect();
        const x = Math.round(e.clientX - rect.left);
        const y = Math.round(e.clientY - rect.top);
        dot.style.display = 'block';
        dot.style.left = x + 'px';
        dot.style.top = y + 'px';
        mapData = `${x},${y}`;
    }

    function finish() {
        // 現在の回答を配列にまとめる
        let row = [respondentId];
        const singleQ = ["Q1","Q3","Q4","Q5","Q6","Q11","Q12","Q16","Q17"];
        singleQ.forEach(q => row.push(document.querySelector(`input[name="${q}"]:checked`)?.value || ""));
        
        const multiQ = ["Q2","Q7","Q9","Q10","Q14","Q15","Q162"];
        multiQ.forEach(q => {
            let vals = Array.from(document.querySelectorAll(`input[name="${q}"]:checked`)).map(i => i.value);
            row.push(vals.join('|'));
        });
        
        row.push(mapData);
        row.push(document.getElementById('Q11_text').value.replace(/,/g, ' '));
        row.push(document.getElementById('Q13').value.replace(/,/g, ' '));

        // ローカルストレージに保存
        let allData = JSON.parse(localStorage.getItem('survey_data') || "[]");
        allData.push(row);
        localStorage.setItem('survey_data', JSON.stringify(allData));

        // 次のIDへ
        localStorage.setItem('respondentId', Number(respondentId) + 1);
        move('End');
    }

    function downloadCSV() {
        const allData = JSON.parse(localStorage.getItem('survey_data') || "[]");
        if (allData.length === 0) return alert("まだ回答データがありません。");

        let csv = "\uFEFFID,Q1,Q3,Q4,Q5,Q6,Q11,Q12,Q16,Q17,Q2,Q7,Q9,Q10,Q14,Q15,Q162,Map,Q11自由,Q13自由\n";
        allData.forEach(r => { csv += r.join(",") + "\n"; });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `daizu_survey_${new Date().toLocaleDateString()}.csv`;
        a.click();
    }
</script>

</body>
</html>
