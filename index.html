<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>大洲市 アンケート</title>
    <style>
        :root { --blue: #007bff; --green: #28a745; --gray: #6c757d; --bg: #f4f7f9; }
        body { font-family: "Helvetica Neue", Arial, sans-serif; background: var(--bg); margin: 0; padding: 0; display: flex; justify-content: center; }
        .container { background: white; width: 100%; max-width: 700px; min-height: 100vh; padding: 40px 20px; box-sizing: border-box; position: relative; padding-bottom: 100px; }
        .screen { display: none; }
        .active { display: block; animation: fadeIn 0.2s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        #id-display { position: absolute; top: 10px; left: 15px; font-size: 0.8rem; color: #999; font-weight: bold; }
        h2 { font-size: 1.3rem; color: #333; margin-bottom: 20px; border-left: 5px solid var(--blue); padding-left: 15px; line-height: 1.4; }
        
        .section-box { text-align: left; }
        .section-title { font-size: 1.5rem; color: var(--blue); margin-bottom: 20px; border-bottom: 2px solid var(--blue); padding-bottom: 10px; }
        .flex-row { display: flex; gap: 20px; align-items: flex-start; }
        .flex-text { flex: 1; line-height: 1.6; }
        .flex-img { width: 220px; height: auto; border-radius: 8px; border: 1px solid #ddd; }

        .options { display: flex; flex-direction: column; gap: 10px; margin: 20px 0; }
        .opt { display: flex; align-items: center; padding: 15px; border: 2px solid #eee; border-radius: 10px; cursor: pointer; font-size: 1.05rem; transition: 0.2s; }
        .opt:active { background: #f0f0f0; }
        .opt input { margin-right: 15px; transform: scale(1.4); }
        
        textarea { width: 100%; height: 120px; padding: 15px; border-radius: 10px; border: 2px solid #ddd; font-size: 1rem; box-sizing: border-box; }
        
        /* 地図ボックス */
        .map-box { width: 100%; height: 400px; background: #ddd; border-radius: 15px; position: relative; overflow: hidden; border: 2px solid #ccc; background-image: url('map.png'); background-size: cover; background-position: center; z-index: 1; cursor: crosshair; }
        #map-dot { position: absolute; width: 24px; height: 24px; background: red; border-radius: 50%; border: 3px solid white; transform: translate(-50%, -50%); pointer-events: none; z-index: 999; display: none; box-shadow: 0 0 10px rgba(0,0,0,0.5); }

        .nav { display: flex; justify-content: space-between; margin-top: 30px; gap: 15px; }
        button { flex: 1; padding: 18px; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: bold; cursor: pointer; }
        .btn-next { background: var(--blue); color: white; }
        .btn-back { background: var(--gray); color: white; }
        .btn-start { background: var(--green); color: white; width: 100%; font-size: 1.3rem; }
        
        .btn-reset-small { position: fixed; bottom: 10px; right: 10px; padding: 8px 12px; font-size: 0.75rem; background: rgba(0,0,0,0.3); color: white; border-radius: 5px; z-index: 10000; width: auto; font-weight: normal; }
        .admin-section { margin-top: 500px; border-top: 1px dashed #ccc; padding-top: 20px; text-align: center; }
        .btn-admin { background: #333; color: white; font-size: 0.8rem; padding: 10px; margin: 5px; width: auto; display: inline-block; }

        /* 集計マップ用レイヤー */
        #summary-layer { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:10001; overflow-y:auto; padding:20px; box-sizing:border-box; color:white; text-align:center;}
        #summary-canvas { max-width:100%; border:2px solid white; margin-top:10px; }
    </style>
</head>
<body>

<div class="container">
    <div id="id-display">回答者ID: <span id="current-id">1</span></div>
    <button class="btn-reset-small" onclick="if(confirm('最初に戻りますか？')) location.reload();">最初に戻る</button>

    <div id="q0" class="screen active">
        <h1 style="text-align:center; margin-top:100px;">東京大学工学部<br>～大洲市の未来のまちを考える～</h1>
        <p style="text-align:center; color:#666; line-height: 1.8;">研究のためのアンケート調査にご協力をお願いいたします。</p>
        <button class="btn-start" onclick="move(1)">アンケートを始める</button>
        <div class="admin-section">
            <button class="btn-admin" onclick="showMapSummary()">集計マップを表示</button>     
            <button class="btn-admin" onclick="downloadCSV()">CSVダウンロード</button>
            <button class="btn-admin" style="background:#cc0000;" onclick="if(confirm('全データ消去？')) { localStorage.clear(); location.reload(); }">データリセット</button>
        </div>
    </div>

    <div id="q1" class="screen">
        <h2>Q1. 年齢を教えてください。</h2>
        <div class="options">
            <label class="opt"><input type="radio" name="Q1" value="10代以下"> 10代以下</label>
            <label class="opt"><input type="radio" name="Q1" value="20代"> 20代</label>
            <label class="opt"><input type="radio" name="Q1" value="30代"> 30代</label>
            <label class="opt"><input type="radio" name="Q1" value="40代"> 40代</label>
            <label class="opt"><input type="radio" name="Q1" value="50代"> 50代</label>
            <label class="opt"><input type="radio" name="Q1" value="60代"> 60代</label>
            <label class="opt"><input type="radio" name="Q1" value="70代以上"> 70代以上</label>
        </div>
        <div class="nav"><button class="btn-back" onclick="move(0)">戻る</button><button class="btn-next" onclick="move(2)">次へ</button></div>
    </div>

    <div id="q2" class="screen">
        <h2>Q2. 今のお仕事や状況を教えてください。（複数選択可）</h2>
        <div class="options">
            <label class="opt"><input type="checkbox" name="Q2" value="会社員・公務員"> 会社員・公務員</label>
            <label class="opt"><input type="checkbox" name="Q2" value="自営業・フリーランス"> 自営業・フリーランス</label>
            <label class="opt"><input type="checkbox" name="Q2" value="学生"> 学生</label>
            <label class="opt"><input type="checkbox" name="Q2" value="専業主婦・主夫"> 専業主婦・主夫</label>
            <label class="opt"><input type="checkbox" name="Q2" value="その他"> その他</label>
        </div>
        <div class="nav"><button class="btn-back" onclick="move(1)">戻る</button><button class="btn-next" onclick="move(3)">次へ</button></div>
    </div>

    <div id="q3" class="screen">
        <h2>Q3. どのあたりにお住まいですか？</h2>
        <div class="options" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <label class="opt"><input type="radio" name="Q3" value="大洲"> 大洲</label>
            <label class="opt"><input type="radio" name="Q3" value="中村"> 中村</label>
            <label class="opt"><input type="radio" name="Q3" value="西大洲"> 西大洲</label>
            <label class="opt"><input type="radio" name="Q3" value="若宮"> 若宮</label>
            <label class="opt"><input type="radio" name="Q3" value="久米"> 久米</label>
            <label class="opt"><input type="radio" name="Q3" value="南久米"> 南久米</label>
            <label class="opt"><input type="radio" name="Q3" value="肱南町"> 肱南町</label>
            <label class="opt"><input type="radio" name="Q3" value="平野町"> 平野町</label>
            <label class="opt"><input type="radio" name="Q3" value="東大洲"> 東大洲</label>
            <label class="opt"><input type="radio" name="Q3" value="徳森"> 徳森</label>
            <label class="opt"><input type="radio" name="Q3" value="新谷"> 新谷</label>
            <label class="opt"><input type="radio" name="Q3" value="菅田町"> 菅田町</label>
            <label class="opt"><input type="radio" name="Q3" value="その他(大洲市内)"> その他(大洲市内)</label>
            <label class="opt"><input type="radio" name="Q3" value="その他(愛媛県内)"> その他(愛媛県内)</label>
            <label class="opt"><input type="radio" name="Q3" value="その他(愛媛県外)"> その他(愛媛県外)</label>
        </div>
        <div class="nav"><button class="btn-back" onclick="move(2)">戻る</button><button class="btn-next" onclick="toNextFromQ3()">次へ</button></div>
    </div>

    <div id="q4" class="screen">
        <h2>Q4. これまでに大洲で水害にあったことはありますか？</h2>
        <div class="options">
            <label class="opt"><input type="radio" name="Q4" value="ある(大きな被害が出た)"> ある(大きな被害が出た)</label>
            <label class="opt"><input type="radio" name="Q4" value=" ある(少しの被害だった)"> ある(少しの被害だった)</label>
            <label class="opt"><input type="radio" name="Q4" value="ない"> ない</label>
        </div>
        <div class="nav"><button class="btn-back" onclick="move(3)">戻る</button><button class="btn-next" onclick="move(5)">次へ</button></div>
    </div>

    <div id="q5" class="screen">
        <h2>Q5. 同居者の人数を教えてください。</h2>
        <div class="options">
            <label class="opt"><input type="radio" name="Q5" value="1人"> 1人（単身）</label>
            <label class="opt"><input type="radio" name="Q5" value="2人"> 2人</label>
            <label class="opt"><input type="radio" name="Q5" value="3人"> 3人</label>
            <label class="opt"><input type="radio" name="Q5" value="4人以上"> 4人以上</label>
        </div>
        <div class="nav"><button class="btn-back" onclick="backFromQ5()">戻る</button><button class="btn-next" onclick="move('s6')">次へ</button></div>
    </div>

    <div id="qs6" class="screen">
        <div class="section-box">
            <div class="section-title">伝承館に関する質問</div>
            <div class="flex-row">
                <div class="flex-text">
                    <p>過去の水害災害を未来へ伝える伝承機能を持った拠点の創出を検討しています。</p>
                    <p style="font-size: 0.9rem; color:#666;">（参考：雲仙岳災害記念館がまだすドーム）</p>
                </div>
                <img src="unzen.jpg" alt="参考画像" class="flex-img" onerror="this.src='https://via.placeholder.com/220x150?text=Reference+Image'">
            </div>
        </div>
        <div class="nav"><button class="btn-back" onclick="move(5)">戻る</button><button class="btn-next" onclick="move(6)">質問へ進む</button></div>
    </div>

    <div id="q6" class="screen">
        <h2>Q6. 水害の記憶を伝える伝承館ができたら、行ってみたいですか？</h2>
        <div class="options">
            <label class="opt"><input type="radio" name="Q6" value="はい"> はい</label>
            <label class="opt"><input type="radio" name="Q6" value="いいえ"> いいえ</label>
        </div>
        <div class="nav"><button class="btn-back" onclick="move('s6')">戻る</button><button class="btn-next" onclick="move(7)">次へ</button></div>
    </div>

    <div id="q7" class="screen">
        <h2>Q7. どのような展示内容があれば伝承館に行きたいと思いますか？（複数選択可）</h2>
        <div class="options">
            <label class="opt"><input type="checkbox" name="Q7" value="当時の写真・映像パネル"> 当時の写真・映像パネル</label>
            <label class="opt"><input type="checkbox" name="Q7" value="被災者の体験談コーナー"> 被災者の体験談コーナー</label>
            <label class="opt"><input type="checkbox" name="Q7" value="防災ワークショップ"> 防災ワークショップ</label>
            <label class="opt"><input type="checkbox" name="Q7" value="子ども向け体験展示"> 子ども向け体験展示</label>
            <label class="opt"><input type="checkbox" name="Q7" value="AR・VR疑似体験"> AR・VR疑似体験</label>
            <label class="opt"><input type="checkbox" name="Q7" value="子どもが遊べる屋内スペース"> 子どもが遊べる屋内スペース</label>
            <label class="opt"><input type="checkbox" name="Q7" value="勉強・読書スペース"> 勉強・読書スペース</label>
            <label class="opt"><input type="checkbox" name="Q7" value="カフェ・休憩所"> カフェ・休憩所</label>
        </div>
        <div class="nav"><button class="btn-back" onclick="move(6)">戻る</button><button class="btn-next" onclick="move(8)">次へ</button></div>
    </div>

    <div id="q8" class="screen">
        <h2>Q8. 伝承館を作るなら、どこが良いと思いますか？</h2>
        <p style="color:#666;">地図上をタップしてください</p>
        <div class="map-box" onclick="setMap(event)">
            <div id="map-dot"></div>
        </div>
        <div class="nav"><button class="btn-back" onclick="move(7)">戻る</button><button class="btn-next" onclick="finish()">回答を完了する</button></div>
    </div>

    <div id="qEnd" class="screen" style="text-align:center;">
        <h2 style="border:none; margin-top:100px;">ご協力ありがとうございました</h2>
        <button class="btn-start" onclick="location.reload()" style="background:var(--blue); margin-top:30px;">最初に戻る</button>
    </div>
</div>

<div id="summary-layer">
    <h3>集計結果マップ</h3>
    <canvas id="summary-canvas"></canvas><br>
    <button onclick="document.getElementById('summary-layer').style.display='none'" style="padding:10px 20px; margin-top:10px;">閉じる</button>
</div>

    <div id="qs9" class="screen">
        <div class="section-box">
            <div class="section-title">居住エリアの重心誘導について</div>
            <p>災害リスク等の観点から、現在は東大洲に多い住宅地エリアを伊予大洲駅周辺エリアに誘導することを検討しています。</p>
        </div>
        <div class="nav"><button class="btn-back" onclick="move(8)">戻る</button><button class="btn-next" onclick="move(9)">質問へ進む</button></div>
    </div>

    <div id="q9" class="screen">
        <h2>Q9. 現在の居住地を選んだ理由を教えてください。（複数選択可）</h2>
        <div class="options">
            <label class="opt"><input type="checkbox" name="Q9" value="昔から住んでいる"> 昔から住んでいる</label>
            <label class="opt"><input type="checkbox" name="Q9" value="実家・親族が近い"> 実家・親族が近い</label>
            <label class="opt"><input type="checkbox" name="Q9" value=" 地価・家賃が安い"> 地価・家賃が安い</label>
            <label class="opt"><input type="checkbox" name="Q9" value="通勤・通学に便利"> 通勤・通学に便利</label>
             <label class="opt"><input type="checkbox" name="Q9" value="子育てがしやすい"> 子育てがしやすい</label>
            <label class="opt"><input type="checkbox" name="Q9" value="災害リスクが低い"> 災害リスクが低い</label>
            <label class="opt"><input type="checkbox" name="Q9" value="その他"> その他</label>
        </div>
        <div class="nav"><button class="btn-back" onclick="move('s9')">戻る</button><button class="btn-next" onclick="move(10)">次へ</button></div>
    </div>

    <div id="q10" class="screen">
        <h2>Q10. どのような条件があれば伊予大洲駅周辺エリアに住みたいと思いますか？（複数選択可）</h2>
        <div class="options">
            <label class="opt"><input type="checkbox" name="Q10" value="地価が安い"> 地価が安い</label>
            <label class="opt"><input type="checkbox" name="Q10" value="スーパー・店が近い"> スーパー・店が近い</label>
            <label class="opt"><input type="checkbox" name="Q10" value="通勤・通学に便利"> 通勤・通学に便利</label>
            <label class="opt"><input type="checkbox" name="Q10" value="公共交通の充実"> 公共交通の充実</label>
            <label class="opt"><input type="checkbox" name="Q10" value="駐車場が広い"> 駐車場が広い</label>
            <label class="opt"><input type="checkbox" name="Q10" value="病院などの医療機関が近い"> 病院などの医療機関が近い</label>
            <label class="opt"><input type="checkbox" name="Q10" value="ピロティ建築等の補助"> ピロティ建築等の補助</label>
        </div>
        <div class="nav"><button class="btn-back" onclick="move(9)">戻る</button><button class="btn-next" onclick="move('s12')">次へ</button></div>
    </div>

    <div id="qs12" class="screen">
        <div class="section-box">
            <div class="section-title">豪雨災害における避難について</div>
            <p>防災力を高めるまちづくりについて考えています。</p>
        </div>
        <div class="nav"><button class="btn-back" onclick="move(10)">戻る</button><button class="btn-next" onclick="move(12)">質問へ進む</button></div>
    </div>

    <div id="q12" class="screen">
        <h2>Q12. 避難指示があったときにどのように避難しますか？</h2>
        <div class="options">
            <label class="opt"><input type="radio" name="Q12" value="自動車"> 自動車</label>
            <label class="opt"><input type="radio" name="Q12" value="徒歩"> 徒歩</label>
            <label class="opt"><input type="radio" name="Q12" value="自転車・バイク"> 自転車・バイク</label>
            <label class="opt"><input type="radio" name="Q12" value="避難不要と考えている"> 避難不要と考えている</label>
            <label class="opt"><input type="radio" name="Q12" value="その他"> その他</label>
        </div>
        <div class="nav"><button class="btn-back" onclick="move('s12')">戻る</button><button class="btn-next" onclick="branchQ12()">次へ</button></div>
    </div>

    <div id="q13" class="screen">
        <h2>Q13. 車の避難先（自由記述）</h2>
        <textarea id="Q13_free" placeholder="場所など"></textarea>
        <div class="nav"><button class="btn-back" onclick="move(12)">戻る</button><button class="btn-next" onclick="move(14)">次へ</button></div>
    </div>

    <div id="q14" class="screen">
        <h2>Q14. 避難するときにほしい支援を選んでください。（複数選択可）</h2>
        <div class="options">
            <label class="opt"><input type="checkbox" name="Q14" value="バスによる輸送"> バスによる輸送</label>
            <label class="opt"><input type="checkbox" name="Q14" value="情報提供"> 情報提供</label>
            <label class="opt"><input type="checkbox" name="Q14" value="駐車場の確保"> 駐車場の確保</label>
            <label class="opt"><input type="checkbox" name="Q14" value="物資（水・食料）"> 物資（水・食料）</label>
            <label class="opt"><input type="checkbox" name="Q14" value="その他"> その他</label>
        </div>
        <div class="nav"><button class="btn-back" onclick="backFrom14()">戻る</button><button class="btn-next" onclick="move(15)">次へ</button></div>
    </div>

    <div id="q15" class="screen">
        <h2>Q15. 避難時に欲しい情報を選んでください。（複数選択可）</h2>
        <div class="options">
            <label class="opt"><input type="checkbox" name="Q15" value="避難所の場所・空き状況"> 避難所の場所・空き状況</label>
            <label class="opt"><input type="checkbox" name="Q15" value="避難所の設備"> 避難所の設備</label>
            <label class="opt"><input type="checkbox" name="Q15" value="洪水の危険度・浸水予測"> 洪水の危険度・浸水予測</label>
            <label class="opt"><input type="checkbox" name="Q15" value="道路の通行止め情報"> 道路の通行止め情報</label>
            <label class="opt"><input type="checkbox" name="Q15" value="避難するタイミング"> 避難するタイミング</label>
        </div>
        <div class="nav"><button class="btn-back" onclick="move(14)">戻る</button><button class="btn-next" onclick="move('s16')">次へ</button></div>
    </div>

    <div id="qs16" class="screen">
        <div class="section-box">
            <div class="section-title">バスの利用について</div>
            <p>公共交通機関の利用について考えています。</p>
        </div>
        <div class="nav"><button class="btn-back" onclick="move(15)">戻る</button><button class="btn-next" onclick="move(16)">質問へ進む</button></div>
    </div>

    <div id="q16" class="screen">
        <h2>Q16. 普段、バスを利用しますか？</h2>
        <div class="options">
            <label class="opt"><input type="radio" name="Q16" value="よく使う"> よく使う</label>
            <label class="opt"><input type="radio" name="Q16" value="たまに使う"> たまに使う</label>
            <label class="opt"><input type="radio" name="Q16" value="ほとんど使わない"> ほとんど使わない</label>
        </div>
        <div class="nav"><button class="btn-back" onclick="move('s16')">戻る</button><button class="btn-next" onclick="branchQ16()">次へ</button></div>
    </div>

    <div id="q162" class="screen">
        <h2>Q16_2. バスの利用目的を教えてください。（複数選択可）</h2>
        <div class="options">
            <label class="opt"><input type="checkbox" name="Q162" value="通勤・通学"> 通勤・通学</label>
            <label class="opt"><input type="checkbox" name="Q162" value="通院"> 通院</label>
            <label class="opt"><input type="checkbox" name="Q162" value="買い物"> 買い物</label>
            <label class="opt"><input type="checkbox" name="Q162" value="遊びに行くため"> 遊びに行くため</label>
            <label class="opt"><input type="checkbox" name="Q162" value="その他"> その他</label>
        </div>
        <div class="nav"><button class="btn-back" onclick="move(16)">戻る</button><button class="btn-next" onclick="toNextFrom16()">次へ</button></div>
    </div>

    <div id="q11" class="screen">
        <h2>Q11. 将来、運転免許を返納するつもりはありますか？</h2>
        <div class="options">
            <label class="opt"><input type="radio" name="Q11" value="返納している"> 返納している</label>
            <label class="opt"><input type="radio" name="Q11" value="返納するつもり"> 返納するつもり</label>
            <label class="opt"><input type="radio" name="Q11" value="条件次第で返納する"> 条件次第で返納する</label>
            <label class="opt"><input type="radio" name="Q11" value="返納しない"> 返納しない</label>
        </div>
        <textarea id="Q11_free" placeholder="理由など"></textarea>
        <div class="nav"><button class="btn-back" onclick="backFrom11()">戻る</button><button class="btn-next" onclick="move(17)">次へ</button></div>
    </div>

    <div id="q17" class="screen">
        <h2>Q17. 災害時に避難所まで行けるバスがあった場合、利用したいですか？</h2>
        <div class="options">
            <label class="opt"><input type="radio" name="Q17" value=" すぐに乗って避難する"> すぐに乗って避難する</label>
            <label class="opt"><input type="radio" name="Q17" value="自力で避難する"> 自力で避難する</label>
            <label class="opt"><input type="radio" name="Q17" value="様子を見る"> 様子を見る</label>
        </div>
        <div class="nav"><button class="btn-back" onclick="backFrom17()">戻る</button><button class="btn-next" onclick="finish()">回答を完了する</button></div>
    </div>

    <div id="qEnd" class="screen" style="text-align:center;">
        <h2 style="border:none; margin-top:100px;">ご協力ありがとうございました</h2>
        <button class="btn-start" onclick="location.reload()" style="background:var(--blue); margin-top:30px;">最初に戻る</button>
    </div>
</div>

<script>
    let respondentId = localStorage.getItem('respondentId') || 1;
    document.getElementById('current-id').innerText = respondentId;
    let currentMapCoord = "未選択";

    function move(n) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        const target = document.getElementById('q' + n);
        if(target) target.classList.add('active');
        window.scrollTo(0, 0);
    }

    function isOutsider() {
        const val = document.querySelector('input[name="Q3"]:checked')?.value;
        return val && val.includes("その他");
    }
    function toNextFromQ3() { if (isOutsider()) move(5); else move(4); }
    function backFromQ5() { if (isOutsider()) move(3); else move(4); }

    // 地図タップ処理の修正
    function setMap(e) {
        const dot = document.getElementById('map-dot');
        const rect = e.currentTarget.getBoundingClientRect();
        const xPx = e.clientX - rect.left;
        const yPx = e.clientY - rect.top;

        const xPct = (xPx / rect.width) * 100;
        const yPct = (yPx / rect.height) * 100;

        dot.style.display = 'block';
        dot.style.left = xPct + '%';
        dot.style.top = yPct + '%';

        currentMapCoord = `${xPct.toFixed(2)},${yPct.toFixed(2)}`;
    }

    function finish() {
        let row = [respondentId];
        const s = ["Q1","Q3","Q4","Q5","Q6"];
        let sV = {}; s.forEach(q => sV[q] = document.querySelector(`input[name="${q}"]:checked`)?.value || "");
        const m = ["Q2","Q7"];
        let mV = {}; m.forEach(q => mV[q] = Array.from(document.querySelectorAll(`input[name="${q}"]:checked`)).map(i => i.value).join('|'));

        row.push(sV["Q1"], mV["Q2"], sV["Q3"], sV["Q4"], sV["Q5"], sV["Q6"], mV["Q7"], currentMapCoord);

        let data = JSON.parse(localStorage.getItem('survey_data') || "[]");
        data.push(row);
        localStorage.setItem('survey_data', JSON.stringify(data));
        localStorage.setItem('respondentId', Number(respondentId) + 1);
        move('End');
    }

    // 集計表示機能
    function showMapSummary() {
        const data = JSON.parse(localStorage.getItem('survey_data') || "[]");
        if (!data.length) return alert("データがありません");

        const canvas = document.getElementById('summary-canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();

        img.onload = function() {
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);

            data.forEach(row => {
                const coordStr = row[row.length - 1]; // 最後の列が座標
                if (coordStr && coordStr !== "未選択") {
                    const [xPct, yPct] = coordStr.split(',').map(Number);
                    const x = (xPct / 100) * canvas.width;
                    const y = (yPct / 100) * canvas.height;

                    ctx.beginPath();
                    ctx.arc(x, y, 15, 0, Math.PI * 2); 
                    ctx.fillStyle = "rgba(255, 0, 0, 0.7)";
                    ctx.fill();
                    ctx.strokeStyle = "white";
                    ctx.lineWidth = 3;
                    ctx.stroke();
                }
            });
            document.getElementById('summary-layer').style.display = 'block';
        };
        img.src = 'map.png'; // 地図画像ファイル名
    }

    function downloadCSV() {
        const data = JSON.parse(localStorage.getItem('survey_data') || "[]");
        if (!data.length) return alert("データなし");
        let csv = "\uFEFFID,年齢,職業,居住地,被災,人数,行きたい,展示,座標\n";
        data.forEach(r => csv += r.join(",") + "\n");
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = `survey.csv`; a.click();
    }
</script>
</body>
</html>
