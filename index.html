<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>大洲市 アンケート</title>
    <style>
        :root { --blue: #007bff; --green: #28a745; --gray: #6c757d; --bg: #f4f7f9; }
        body { font-family: "Helvetica Neue", Arial, sans-serif; background: var(--bg); margin: 0; padding: 0; display: flex; justify-content: center; }
        .container { background: white; width: 100%; max-width: 700px; min-height: 100vh; padding: 40px 20px; box-sizing: border-box; position: relative; padding-bottom: 80px; }
        .screen { display: none; }
        .active { display: block; animation: fadeIn 0.2s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        #id-display { position: absolute; top: 10px; left: 15px; font-size: 0.8rem; color: #999; }
        h2 { font-size: 1.3rem; color: #333; margin-bottom: 20px; border-left: 5px solid var(--blue); padding-left: 15px; }
        .desc { background: #eef2f7; padding: 15px; border-radius: 10px; font-size: 0.95rem; margin-bottom: 20px; color: #444; }
        
        .options { display: flex; flex-direction: column; gap: 10px; margin: 20px 0; }
        .opt { display: flex; align-items: center; padding: 15px; border: 2px solid #eee; border-radius: 10px; cursor: pointer; font-size: 1.05rem; }
        .opt input { margin-right: 15px; transform: scale(1.4); }
        
        textarea { width: 100%; height: 100px; padding: 15px; border-radius: 10px; border: 2px solid #ddd; font-size: 1rem; box-sizing: border-box; }
        .map-box { width: 100%; height: 350px; background: #ddd; border-radius: 15px; position: relative; border: 2px solid #ccc; background-image: url('map.png'); background-size: cover; background-position: center; }
        .dot { position: absolute; width: 20px; height: 20px; background: red; border-radius: 50%; border: 3px solid white; transform: translate(-50%, -50%); pointer-events: none; }

        .nav { display: flex; justify-content: space-between; margin-top: 30px; gap: 15px; }
        button { flex: 1; padding: 18px; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: bold; cursor: pointer; }
        .btn-next { background: var(--blue); color: white; }
        .btn-back { background: var(--gray); color: white; }
        .btn-start { background: var(--green); color: white; width: 100%; font-size: 1.3rem; }
        
        /* 最初に戻るボタン */
        .btn-reset { position: fixed; bottom: 15px; right: 15px; padding: 8px 12px; font-size: 0.7rem; background: rgba(0,0,0,0.3); color: white; border-radius: 5px; z-index: 100; width: auto; flex: none; }
        
        /* 管理用ボタン（終了画面のみ） */
        .admin-box { margin-top: 50px; border-top: 1px solid #eee; padding-top: 20px; text-align: center; }
        .btn-download { background: #333; color: white; font-size: 0.8rem; padding: 10px; width: auto; display: inline-block; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div id="id-display">回答者ID: <span id="current-id">1</span></div>

    <button class="btn-reset" onclick="if(confirm('最初に戻りますか？データは保存されません。')) location.reload()">最初に戻る</button>

    <div id="q0" class="screen active">
        <h1 style="text-align:center; margin-top:100px;">水害伝承スペース提案<br>アンケート</h1>
        <button class="btn-start" onclick="move(1)">アンケートを始める</button>
        <div class="admin-box">
            <p style="font-size:0.7rem; color:#999;">管理者用: これまでの回答を保存</p>
            <button class="btn-download" onclick="downloadCSV()">CSVをダウンロード</button>
            <button class="btn-download" style="background:red;" onclick="if(confirm('全データを消去しますか？')) { localStorage.removeItem('survey_results'); location.reload(); }">データを全消去</button>
        </div>
    </div>

    <div id="q1" class="screen"><h2>Q1. 年齢</h2><div class="options"><label class="opt"><input type="radio" name="Q1" value="10代以下"> 10代以下</label><label class="opt"><input type="radio" name="Q1" value="20代"> 20代</label><label class="opt"><input type="radio" name="Q1" value="30代"> 30代</label><label class="opt"><input type="radio" name="Q1" value="40代"> 40代</label><label class="opt"><input type="radio" name="Q1" value="50代"> 50代</label><label class="opt"><input type="radio" name="Q1" value="60代"> 60代</label><label class="opt"><input type="radio" name="Q1" value="70代以上"> 70代以上</label></div><div class="nav"><button class="btn-back" onclick="move(0)">戻る</button><button class="btn-next" onclick="move(2)">次へ</button></div></div>
    <div id="q2" class="screen"><h2>Q2. 職業</h2><div class="options"><label class="opt"><input type="checkbox" name="Q2" value="会社員・公務員"> 会社員・公務員</label><label class="opt"><input type="checkbox" name="Q2" value="自営業"> 自営業</label><label class="opt"><input type="checkbox" name="Q2" value="学生"> 学生</label><label class="opt"><input type="checkbox" name="Q2" value="専業主婦"> 専業主婦</label><label class="opt"><input type="checkbox" name="Q2" value="その他"> その他</label></div><div class="nav"><button class="btn-back" onclick="move(1)">戻る</button><button class="btn-next" onclick="move(3)">次へ</button></div></div>
    <div id="q3" class="screen"><h2>Q3. 居住地</h2><div class="options"><label class="opt"><input type="radio" name="Q3" value="大洲"> 大洲</label><label class="opt"><input type="radio" name="Q3" value="中村"> 中村</label><label class="opt"><input type="radio" name="Q3" value="若宮"> 若宮</label><label class="opt"><input type="radio" name="Q3" value="その他"> その他</label></div><div class="nav"><button class="btn-back" onclick="move(2)">戻る</button><button class="btn-next" onclick="move(4)">次へ</button></div></div>
    <div id="q4" class="screen"><h2>Q4. 被災経験</h2><div class="options"><label class="opt"><input type="radio" name="Q4" value="ある大"> ある(大きな被害)</label><label class="opt"><input type="radio" name="Q4" value="ある小"> ある(少しの被害)</label><label class="opt"><input type="radio" name="Q4" value="ない"> ない</label></div><div class="nav"><button class="btn-back" onclick="move(3)">戻る</button><button class="btn-next" onclick="move(5)">次へ</button></div></div>
    <div id="q5" class="screen"><h2>Q5. 同居人数</h2><div class="options"><label class="opt"><input type="radio" name="Q5" value="1人"> 1人</label><label class="opt"><input type="radio" name="Q5" value="2人"> 2人</label><label class="opt"><input type="radio" name="Q5" value="3人"> 3人</label><label class="opt"><input type="radio" name="Q5" value="4人以上"> 4人以上</label></div><div class="nav"><button class="btn-back" onclick="move(4)">戻る</button><button class="btn-next" onclick="move(6)">次へ</button></div></div>
    <div id="q6" class="screen"><h2>Q6. 伝承館行きたい？</h2><div class="options"><label class="opt"><input type="radio" name="Q6" value="はい"> はい</label><label class="opt"><input type="radio" name="Q6" value="いいえ"> いいえ</label></div><div class="nav"><button class="btn-back" onclick="move(5)">戻る</button><button class="btn-next" onclick="move(7)">次へ</button></div></div>
    <div id="q7" class="screen"><h2>Q7. 展示内容</h2><div class="options"><label class="opt"><input type="checkbox" name="Q7" value="写真"> 写真</label><label class="opt"><input type="checkbox" name="Q7" value="体験談"> 体験談</label><label class="opt"><input type="checkbox" name="Q7" value="その他"> その他</label></div><div class="nav"><button class="btn-back" onclick="move(6)">戻る</button><button class="btn-next" onclick="move(8)">次へ</button></div></div>
    <div id="q8" class="screen"><h2>Q8. 設置場所</h2><div class="map-box" onclick="setMap(event)"><div id="map-dot"></div></div><div class="nav"><button class="btn-back" onclick="move(7)">戻る</button><button class="btn-next" onclick="move(9)">次へ</button></div></div>
    <div id="q9" class="screen"><h2>Q9. 居住理由</h2><div class="options"><label class="opt"><input type="checkbox" name="Q9" value="実家近"> 実家近</label><label class="opt"><input type="checkbox" name="Q9" value="利便性"> 利便性</label><label class="opt"><input type="checkbox" name="Q9" value="その他"> その他</label></div><div class="nav"><button class="btn-back" onclick="move(8)">戻る</button><button class="btn-next" onclick="move(10)">次へ</button></div></div>
    <div id="q10" class="screen"><h2>Q10. 駅周辺条件</h2><div class="options"><label class="opt"><input type="checkbox" name="Q10" value="地価安"> 地価安</label><label class="opt"><input type="checkbox" name="Q10" value="病院近"> 病院近</label><label class="opt"><input type="checkbox" name="Q10" value="その他"> その他</label></div><div class="nav"><button class="btn-back" onclick="move(9)">戻る</button><button class="btn-next" onclick="move(11)">次へ</button></div></div>
    <div id="q11" class="screen"><h2>Q11. 免許返納</h2><textarea id="Q11_text"></textarea><div class="nav"><button class="btn-back" onclick="move(10)">戻る</button><button class="btn-next" onclick="move(12)">次へ</button></div></div>
    <div id="q12" class="screen"><h2>Q12. 避難手段</h2><div class="options"><label class="opt"><input type="radio" name="Q12" value="車"> 車</label><label class="opt"><input type="radio" name="Q12" value="徒歩"> 徒歩</label></div><div class="nav"><button class="btn-back" onclick="move(11)">戻る</button><button class="btn-next" onclick="move(13)">次へ</button></div></div>
    <div id="q13" class="screen"><h2>Q13. 車避難先</h2><textarea id="Q13"></textarea><div class="nav"><button class="btn-back" onclick="move(12)">戻る</button><button class="btn-next" onclick="move(14)">次へ</button></div></div>
    <div id="q14" class="screen"><h2>Q14. 支援</h2><div class="options"><label class="opt"><input type="checkbox" name="Q14" value="バス輸送"> バス輸送</label><label class="opt"><input type="checkbox" name="Q14" value="情報"> 情報</label></div><div class="nav"><button class="btn-back" onclick="move(13)">戻る</button><button class="btn-next" onclick="move(15)">次へ</button></div></div>
    <div id="q15" class="screen"><h2>Q15. 情報</h2><div class="options"><label class="opt"><input type="checkbox" name="Q15" value="避難所場所"> 避難所場所</label><label class="opt"><input type="checkbox" name="Q15" value="洪水予測"> 洪水予測</label></div><div class="nav"><button class="btn-back" onclick="move(14)">戻る</button><button class="btn-next" onclick="move(16)">次へ</button></div></div>

    <div id="q16" class="screen">
        <h2>Q16. 普段のバス利用頻度は？</h2>
        <div class="options">
            <label class="opt"><input type="radio" name="Q16" value="よく使う"> よく使う</label>
            <label class="opt"><input type="radio" name="Q16" value="たまに使う"> たまに使う</label>
            <label class="opt"><input type="radio" name="Q16" value="ほとんど使わない"> ほとんど使わない</label>
        </div>
        <div class="nav"><button class="btn-back" onclick="move(15)">戻る</button><button class="btn-next" onclick="checkBusAndMove()">次へ</button></div>
    </div>

    <div id="q162" class="screen">
        <h2>Q16-2. バスの利用目的は？</h2>
        <div class="options">
            <label class="opt"><input type="checkbox" name="Q162" value="通勤通学"> 通勤・通学</label>
            <label class="opt"><input type="checkbox" name="Q162" value="通院"> 通院</label>
            <label class="opt"><input type="checkbox" name="Q162" value="その他"> その他</label>
        </div>
        <div class="nav"><button class="btn-back" onclick="move(16)">戻る</button><button class="btn-next" onclick="move(17)">次へ</button></div>
    </div>

    <div id="q17" class="screen">
        <h2>Q17. 巡回バスへの避難意向</h2>
        <div class="options"><label class="opt"><input type="radio" name="Q17" value="すぐ乗る"> すぐ乗る</label><label class="opt"><input type="radio" name="Q17" value="自力"> 自力</label></div>
        <div class="nav"><button class="btn-back" onclick="move(16)">戻る</button><button class="btn-next" onclick="finish()">完了</button></div>
    </div>

    <div id="qEnd" class="screen" style="text-align:center;">
        <h2>ご協力ありがとうございました</h2>
        <p>回答は正常に記録されました。</p>
        <button class="btn-start" onclick="location.reload()" style="background:var(--blue);">次の人へ</button>
    </div>
</div>

<script>
    let respondentId = localStorage.getItem('respondentId') || 1;
    document.getElementById('current-id').innerText = respondentId;
    let mapData = "未選択";

    function move(n) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('q' + n).classList.add('active');
    }

    // 分岐処理
    function checkBusAndMove() {
        const val = document.querySelector('input[name="Q16"]:checked')?.value;
        if (val === "ほとんど使わない") move(17);
        else move(162);
    }

    function setMap(e) {
        const rect = e.currentTarget.getBoundingClientRect();
        const x = Math.round(e.clientX - rect.left);
        const y = Math.round(e.clientY - rect.top);
        document.getElementById('map-dot').style.left = x + 'px';
        document.getElementById('map-dot').style.top = y + 'px';
        mapData = `${x}_${y}`;
    }

    function finish() {
        // データ収集
        let dataRow = [respondentId];
        const single = ["Q1","Q3","Q4","Q5","Q6","Q12","Q16","Q17"];
        single.forEach(q => dataRow.push(document.querySelector(`input[name="${q}"]:checked`)?.value || ""));
        
        const multi = ["Q2","Q7","Q9","Q10","Q14","Q15","Q162"];
        multi.forEach(q => {
            let vals = Array.from(document.querySelectorAll(`input[name="${q}"]:checked`)).map(i => i.value);
            dataRow.push(vals.join('|')); // 複数回答は | で区切る
        });
        
        dataRow.push(mapData);
        dataRow.push(document.getElementById('Q11_text').value.replace(/\n/g, ' '));
        dataRow.push(document.getElementById('Q13').value.replace(/\n/g, ' '));

        // ローカルに保存 (CSV形式で追記)
        let savedData = JSON.parse(localStorage.getItem('survey_results') || "[]");
        savedData.push(dataRow);
        localStorage.setItem('survey_results', JSON.stringify(savedData));

        // ID更新
        localStorage.setItem('respondentId', Number(respondentId) + 1);
        move('End');
    }

    // CSVとしてダウンロード
    function downloadCSV() {
        let savedData = JSON.parse(localStorage.getItem('survey_results') || "[]");
        if (savedData.length === 0) return alert("データがありません");
        
        let csvContent = "\uFEFFID,年齢,居住地,被災経験,人数,意向,手段,頻度,意向2,職,内容,理由,条件,支援,情報,目的,地図,Q11,Q13\n";
        savedData.forEach(row => { csvContent += row.join(",") + "\n"; });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `survey_results_${new Date().toLocaleDateString()}.csv`;
        link.click();
    }
</script>
</body>
</html>
